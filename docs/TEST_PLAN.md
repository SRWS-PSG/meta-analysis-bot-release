# メタ解析ボット テスト計画

## 概要
examplesディレクトリの全CSVファイルを使用して、メタ解析ボットの対話型動作を体系的にテストします。
各テストケースでは、Gemini AIによる自然言語対話を通じてパラメータを収集し、解析を実行します。

## テスト環境
- **メタ解析ボット ID**: U08TKJ1JQ77
- **テスト用チャンネル**: C066EQ49QVD
- **アップロードボット**: testmessenger (U090S37CJ2D)

## テストケース

### 1. 二値アウトカムデータ (`example_binary_meta_dataset.csv`)
- **目的**: OR/RR/RD解析の動作確認
- **期待される対話フロー**: 
  1. CSVアップロード後、ボットが二値アウトカムデータを検出
  2. 効果量タイプ（OR/RR/RD）について質問
  3. 統計モデル（ランダム/固定）について質問
  4. サブグループ解析の有無を確認
  5. パラメータ確認後、解析を実行
- **対話例**:
  ```
  User: @bot [CSVアップロード]
  Bot: 二値アウトカムデータを検出しました。どの効果量で解析しますか？
  User: オッズ比でお願いします
  Bot: ランダム効果モデルと固定効果モデルのどちらを使用しますか？
  User: ランダムで
  ```

### 2. 連続アウトカムデータ (`example_continuous_meta_dataset.csv`)
- **目的**: SMD/MD解析の動作確認
- **期待される対話フロー**:
  1. 連続アウトカムデータの検出
  2. 標準化の必要性について確認（SMD vs MD）
  3. 統計モデルの選択
  4. メタ回帰の実施有無を確認
- **対話例**:
  ```
  User: @bot [CSVアップロード]
  Bot: 連続アウトカムデータを検出しました。標準化平均差（SMD）と平均差（MD）のどちらで解析しますか？
  User: 単位が異なるのでSMDで
  ```

### 3. ハザード比データ (`example_hazard_ratio_meta_dataset.csv`)
- **目的**: ログ変換の自動検出と対話確認
- **期待される対話フロー**:
  1. HR列の検出
  2. ログ変換済みかどうかの確認
  3. 信頼区間の形式について質問
  4. 解析パラメータの最終確認
- **対話例**:
  ```
  Bot: ハザード比データを検出しました。データは既にログ変換されていますか？
  User: いいえ、生のHR値です
  Bot: 了解しました。ログ変換を適用して解析します。
  ```

### 4. 比率データ (`example_proportion_meta_dataset.csv`)
- **目的**: 単一群比率の解析と変換方法の選択
- **期待される対話フロー**:
  1. 比率データの検出
  2. 変換方法（PLO、PR、PAS等）の選択
  3. 信頼区間の方法について確認
- **対話例**:
  ```
  Bot: 単一群の比率データを検出しました。どの変換方法を使用しますか？
  User: よくわからないので推奨を教えて
  Bot: 比率が0.1-0.9の範囲ならPLO（ロジット変換）、極端な値があればPFT（Freeman-Tukey変換）を推奨します。
  ```

### 5. コードブロック形式での対話
- **目的**: ファイル添付以外の入力での対話確認
- **期待される対話フロー**:
  1. コードブロック内のCSVデータを解析
  2. データ構造に基づいた質問を生成
  3. 通常のファイルアップロードと同じ対話フロー
- **対話例**:
  ````
  User: @bot
  ```
  Study,Events,Total
  Study1,10,50
  Study2,15,60
  ```
  Bot: 比率データを検出しました。単一群のメタ解析を行いますか？
  ````

### 6. 複雑な対話シナリオ
- **目的**: 文脈理解と継続的な対話の確認
- **期待される対話フロー**:
  1. 曖昧な要求への対応
  2. 追加情報の要求
  3. 前の会話を参照した質問
  4. パラメータの修正・確認
- **対話例**:
  ```
  User: このデータで解析して
  Bot: CSVを分析しました。どのような解析を行いますか？
  User: 普通のやつで
  Bot: 二値アウトカムデータなので、オッズ比での解析を推奨します。よろしいですか？
  User: あ、でも地域別に見たい
  Bot: 承知しました。地域別のサブグループ解析も追加します。他に条件はありますか？
  ```

## 実行手順

### 1. 基本的な対話テスト
```bash
# CSVアップロード後、自然な対話を開始
python3 test_slack_upload.py \
  --bot-id U08TKJ1JQ77 \
  --example binary

# ボットの質問に対して自然に応答
# 例: "オッズ比で" → "ランダムモデルで" → "地域別のサブグループも"
```

### 2. シナリオベースのテスト
```bash
# シナリオ1: 初心者ユーザーを想定
python3 test_slack_upload.py --example continuous
# → "よくわからないので推奨で" などの曖昧な応答をテスト

# シナリオ2: 詳細な要求を持つユーザー
python3 test_slack_upload.py --example binary
# → "ORでREMLを使って、地域と年度でサブグループ解析" など具体的な要求

# シナリオ3: 対話中の変更要求
python3 test_slack_upload.py --example hazard_ratio
# → 途中で "やっぱり固定効果で" など変更をテスト
```

### 3. 対話ログの確認
```bash
# リアルタイムでボットとの対話を監視
heroku logs --tail | grep -E "(User message:|Bot response:|Gemini)"

# 対話履歴の保存
heroku logs --since "2025-01-07T00:00:00Z" > dialogue_test_log.txt
```

### 4. 対話品質の評価ポイント
- ボットの質問が文脈に適しているか
- 曖昧な入力への対応が適切か
- 必要な情報が揃うまで対話を継続するか
- パラメータ確認が分かりやすいか

## デバッグチェックリスト

### 対話が正しく機能しない場合
- [ ] Gemini APIキーが正しく設定されているか
- [ ] DialogStateが適切に管理されているか
- [ ] 会話履歴が正しく保存されているか
- [ ] Function Callingの定義が正しいか

### ボットが反応しない場合
- [ ] ボットがチャンネルに招待されているか
- [ ] メンションが正しく含まれているか
- [ ] Herokuアプリが起動しているか
- [ ] 環境変数が正しく設定されているか

### CSV解析でエラーが出る場合
- [ ] CSVフォーマットが正しいか
- [ ] 必要な列が含まれているか
- [ ] データ型が適切か（数値/文字列）
- [ ] エンコーディングはUTF-8か

### 対話フローが中断する場合
- [ ] パラメータ抽出が正しく動作しているか
- [ ] 必須パラメータの定義が適切か
- [ ] エラーハンドリングが機能しているか
- [ ] タイムアウト設定が適切か

## 監視ポイント

### Slackでの対話品質確認
1. 初回応答が3秒以内に返るか
2. CSV分析結果の説明が分かりやすいか
3. ボットの質問が文脈に沿っているか
4. ユーザーの曖昧な入力を適切に解釈するか
5. パラメータ確認メッセージが明確か
6. 解析開始前の最終確認があるか

### Herokuログでの対話フロー確認
1. `Conversation state updated`のログ
2. `Gemini dialogue initiated`のログ
3. `Parameters extracted`の内容確認
4. `Missing parameters`のチェック
5. Function Callingの実行ログ
6. エラーリトライの動作確認

### 対話コンテキストの確認
```bash
# Redis/メモリ内の会話状態を確認
heroku run python -c "
from utils.conversation_state import ConversationStateManager
manager = ConversationStateManager()
# スレッドIDを指定して状態を確認
state = manager.get_state('THREAD_ID')
print(state)
"
```

## トラブルシューティング

### よくある問題と解決策

#### 1. 対話が途中で止まる
```bash
# 会話状態をリセット
heroku run python -c "
from utils.conversation_state import ConversationStateManager
manager = ConversationStateManager()
manager.clear_state('THREAD_ID')
"
```
- DialogStateがANALYSIS_PREFERENCEのままになっていないか確認
- Gemini APIのレート制限に達していないか確認

#### 2. ボットが同じ質問を繰り返す
- 会話履歴が正しく保存されているか確認
- パラメータ抽出のFunction Callingが正しく動作しているか
- extracted_parametersが更新されているか確認

#### 3. 「channel_not_found」エラー
```bash
# ボットをチャンネルに招待
/invite @metaanalysisbot
/invite @testmessenger
```

#### 4. CSV列が検出されない
- Geminiプロンプトの改善が必要
- CSVの最初の数行を確認
- 列名の形式を確認

#### 5. 対話の文脈が失われる
- ストレージバックエンドの設定確認
- 会話履歴の保存期限（48時間）を超えていないか
- メモリストレージの場合、Dynoが再起動していないか

#### 6. パラメータが正しく抽出されない
```bash
# Gemini Function Callingのログを確認
heroku logs --tail | grep "Function call result"
```
- Pydanticモデルの定義を確認
- 列挙型（Enum）の値が適切か確認

## 対話テストのベストプラクティス

### 1. 段階的なテスト
1. まず明確な指示でテスト（「オッズ比でランダム効果モデル」）
2. 次に曖昧な指示でテスト（「普通のやつで」）
3. 最後に複雑な対話でテスト（途中で要求変更）

### 2. エッジケースのテスト
- 無効な入力への対応（「効果量はXYZで」など存在しない指定）
- 矛盾する要求（「固定効果でランダム効果」）
- 極端に長い入力や短い入力

### 3. パフォーマンステスト
- 連続した対話での応答速度
- 複数スレッドでの同時対話
- 大きなCSVファイルでの対話フロー